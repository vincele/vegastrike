#!/usr/bin/python
import cgitb; cgitb.enable()
import cgi
import db
import os


# Make browser treat this as an XML file:
print "Content-Type: text/xml"
print ""

form = cgi.FieldStorage()
#check_form(form)
username = form["username"].value
password = form["password"].value

if form.has_key("mod"):
	mod = form["mod"].value
else:
	mod = os.environ.get('QUERY_STRING','')
filedb = db.DBBase(mod)

f=filedb.open_default_file("vegastrike.config")
s=f.read()
f.close()

def myreplace(s,str,replacer):
	where = s.find('"'+str+'"')
	if where==-1:
		return s
	keyfind='value="'
	where2=s[where:].find(keyfind)
	if where2==-1:
		return s
	where2+=len(keyfind)+where
	where3=s[where2:].find('"')
	if where3==-1:
		return s
	where3+=where2
	return s[:where2]+replacer+s[where3:]
def comment(s, str):
	pos=s.find(str)
	if pos==0 or pos==-1:
		return s
	prevendcomment = s.rfind('-->', 0, pos)
	prevbegincomment = s.rfind('<!--', 0, pos)
	if prevbegincomment!=-1:
		if prevendcomment==-1 or prevendcomment<prevbegincomment:
			return s
	return s[:pos]+'<!--'+str+'-->'+s[pos+len(str)+1:]
s = comment(s, '<bind key="y" modifier="none" command="SwitchCombatMode" />')
#s = comment(s, '<bind key="a" modifier="none" command="ToggleWarpDrive" />');

s=myreplace (s,"callsign",username);
s=myreplace (s,"password",password);
s=myreplace (s,"realname",username);
s=myreplace (s,"force_client_connect","true")
s=myreplace (s,"default_mission","net.mission")
print s
